<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grant Database - Interactive Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        
        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #7f8c8d;
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .filter-section {
            margin-bottom: 15px;
        }
        
        .filter-section:last-child {
            margin-bottom: 0;
        }
        
        .filter-label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            color: #2c3e50;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-item label {
            cursor: pointer;
            user-select: none;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        button, input[type="number"] {
            padding: 10px 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            font-weight: 500;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button.secondary {
            background: #95a5a6;
        }
        
        button.secondary:hover {
            background: #7f8c8d;
        }
        
        input[type="number"] {
            width: 100px;
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-wrapper {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        thead {
            background: #34495e;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: top;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .question-number {
            font-weight: 600;
            color: #3498db;
            white-space: nowrap;
        }
        
        .question-text {
            max-width: 400px;
            word-wrap: break-word;
        }
        
        .language-cell {
            max-width: 300px;
            word-wrap: break-word;
            font-size: 13px;
        }
        
        .empty-cell {
            color: #bdc3c7;
            font-style: italic;
        }
        
        .stats {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 4px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .info-message {
            background: #3498db;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .toggle-all {
            margin-left: 10px;
            font-size: 12px;
            padding: 5px 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>Linguistic Questionnaire Database</h1>
            <p class="subtitle">Interactive table viewer with filtering and random sampling</p>
        </div>
    </div>
    
    <div class="container">
        <div class="stats" id="stats">
            <!-- Stats will be loaded here -->
        </div>
        
        <div class="filters">
            <div class="filter-section">
                <label class="filter-label">
                    Groups to Display
                    <button class="toggle-all secondary" onclick="toggleAllGroups(true)">Select All</button>
                    <button class="toggle-all secondary" onclick="toggleAllGroups(false)">Deselect All</button>
                </label>
                <div class="checkbox-group" id="groupCheckboxes">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            
            <div class="filter-section">
                <label class="filter-label">
                    Languages to Display
                    <button class="toggle-all secondary" onclick="toggleAllLanguages(true)">Select All</button>
                    <button class="toggle-all secondary" onclick="toggleAllLanguages(false)">Deselect All</button>
                </label>
                <div class="checkbox-group" id="languageCheckboxes">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            
            <div class="filter-section">
                <label class="filter-label">Display Options</label>
                <div class="controls">
                    <button onclick="loadFullTable()">Show All Questions</button>
                    <button onclick="loadRandomRows()">Random Questions</button>
                    <input type="number" id="randomCount" value="10" min="1" max="103" placeholder="Count">
                    <button class="secondary" onclick="exportToCSV()">Export to CSV</button>
                </div>
            </div>
        </div>
        
        <div id="message"></div>
        
        <div class="table-container">
            <div class="table-wrapper">
                <table id="dataTable">
                    <thead>
                        <tr id="tableHeader">
                            <th>#</th>
                            <th>Question Number</th>
                            <th>Question Text</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="100" class="loading">Select filters and click a display option to view data</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // IMPORTANT: Replace this with your actual API URL from render.com
        const API_URL = 'http://localhost:5000';  // Change this after deployment!
        
        let allQuestions = [];
        let availableLanguages = [];
        let availableGroups = [];
        
        // Load initial data
        window.addEventListener('DOMContentLoaded', async () => {
            await loadLanguages();
            await loadStats();
            await loadGroups();
            initializeCheckboxes();
        });
        
        async function loadLanguages() {
            try {
                const response = await fetch(`${API_URL}/api/languages`);
                const data = await response.json();
                availableLanguages = data.languages || [];
            } catch (error) {
                console.error('Failed to load languages:', error);
                // Fallback to original languages
                availableLanguages = ['russian', 'danish', 'muira', 'nganasan'];
            }
        }
        
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/api/stats`);
                const stats = await response.json();
                
                const statsDiv = document.getElementById('stats');
                statsDiv.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">${stats.total_questions}</div>
                            <div class="stat-label">Total Questions</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stats.by_group.length}</div>
                            <div class="stat-label">Groups</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${availableLanguages.length}</div>
                            <div class="stat-label">Languages</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }
        
        async function loadGroups() {
            try {
                const response = await fetch(`${API_URL}/api/groups`);
                const groups = await response.json();
                availableGroups = groups.map(g => g.group_number);
            } catch (error) {
                showError('Failed to load groups. Make sure the API is running.');
            }
        }
        
        function initializeCheckboxes() {
            // Initialize group checkboxes
            const groupDiv = document.getElementById('groupCheckboxes');
            groupDiv.innerHTML = availableGroups.map(group => `
                <div class="checkbox-item">
                    <input type="checkbox" id="group_${group}" value="${group}" checked>
                    <label for="group_${group}">Group ${group}</label>
                </div>
            `).join('');
            
            // Initialize language checkboxes
            const langDiv = document.getElementById('languageCheckboxes');
            langDiv.innerHTML = availableLanguages.map(lang => `
                <div class="checkbox-item">
                    <input type="checkbox" id="lang_${lang}" value="${lang}" checked>
                    <label for="lang_${lang}">${capitalizeFirst(lang)}</label>
                </div>
            `).join('');
        }
        
        function getSelectedGroups() {
            return availableGroups.filter(group => 
                document.getElementById(`group_${group}`).checked
            );
        }
        
        function getSelectedLanguages() {
            return availableLanguages.filter(lang => 
                document.getElementById(`lang_${lang}`).checked
            );
        }
        
        function toggleAllGroups(checked) {
            availableGroups.forEach(group => {
                document.getElementById(`group_${group}`).checked = checked;
            });
        }
        
        function toggleAllLanguages(checked) {
            availableLanguages.forEach(lang => {
                document.getElementById(`lang_${lang}`).checked = checked;
            });
        }
        
        async function loadFullTable() {
            const selectedGroups = getSelectedGroups();
            const selectedLanguages = getSelectedLanguages();
            
            if (selectedGroups.length === 0) {
                showError('Please select at least one group');
                return;
            }
            
            showLoading();
            
            try {
                // Load all questions from selected groups
                const promises = selectedGroups.map(group => 
                    fetch(`${API_URL}/api/questions/group/${group}`).then(r => r.json())
                );
                
                const results = await Promise.all(promises);
                allQuestions = results.flat();
                
                displayTable(allQuestions, selectedLanguages);
                showMessage(`Showing ${allQuestions.length} questions from ${selectedGroups.length} group(s)`);
            } catch (error) {
                showError('Failed to load questions');
            }
        }
        
        async function loadRandomRows() {
            const selectedGroups = getSelectedGroups();
            const selectedLanguages = getSelectedLanguages();
            const count = parseInt(document.getElementById('randomCount').value) || 10;
            
            if (selectedGroups.length === 0) {
                showError('Please select at least one group');
                return;
            }
            
            showLoading();
            
            try {
                // Load questions from selected groups
                const promises = selectedGroups.map(group => 
                    fetch(`${API_URL}/api/questions/group/${group}`).then(r => r.json())
                );
                
                const results = await Promise.all(promises);
                const allAvailable = results.flat();
                
                // Randomly select
                const shuffled = allAvailable.sort(() => 0.5 - Math.random());
                allQuestions = shuffled.slice(0, Math.min(count, allAvailable.length));
                
                displayTable(allQuestions, selectedLanguages);
                showMessage(`Showing ${allQuestions.length} random questions from ${selectedGroups.length} group(s)`);
            } catch (error) {
                showError('Failed to load questions');
            }
        }
        
        function displayTable(questions, languages) {
            // Update header
            const header = document.getElementById('tableHeader');
            header.innerHTML = `
                <th>#</th>
                <th>Question Number</th>
                <th>Question Text</th>
                ${languages.map(lang => `<th>${capitalizeFirst(lang)}</th>`).join('')}
            `;
            
            // Update body
            const tbody = document.getElementById('tableBody');
            
            if (questions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="100" class="loading">No questions found</td></tr>';
                return;
            }
            
            tbody.innerHTML = questions.map((q, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td class="question-number">${escapeHtml(q.question_number)}</td>
                    <td class="question-text">${escapeHtml(q.question_text)}</td>
                    ${languages.map(lang => {
                        const value = q[lang];
                        if (!value || value.trim() === '') {
                            return '<td class="language-cell empty-cell">â€”</td>';
                        }
                        return `<td class="language-cell">${escapeHtml(value)}</td>`;
                    }).join('')}
                </tr>
            `).join('');
        }
        
        function exportToCSV() {
            if (allQuestions.length === 0) {
                showError('No data to export. Please load questions first.');
                return;
            }
            
            const languages = getSelectedLanguages();
            
            // Create CSV header
            let csv = '"#","Question Number","Question Text"';
            languages.forEach(lang => {
                csv += `,"${capitalizeFirst(lang)}"`;
            });
            csv += '\n';
            
            // Add rows
            allQuestions.forEach((q, index) => {
                csv += `"${index + 1}","${escapeCsv(q.question_number)}","${escapeCsv(q.question_text)}"`;
                languages.forEach(lang => {
                    const value = q[lang] || '';
                    csv += `,"${escapeCsv(value)}"`;
                });
                csv += '\n';
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `grant_database_${Date.now()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('CSV file downloaded successfully');
        }
        
        function showLoading() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '<tr><td colspan="100" class="loading">Loading...</td></tr>';
            clearMessage();
        }
        
        function showError(message) {
            const msgDiv = document.getElementById('message');
            msgDiv.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(clearMessage, 5000);
        }
        
        function showMessage(message) {
            const msgDiv = document.getElementById('message');
            msgDiv.innerHTML = `<div class="info-message">${message}</div>`;
            setTimeout(clearMessage, 5000);
        }
        
        function clearMessage() {
            const msgDiv = document.getElementById('message');
            msgDiv.innerHTML = '';
        }
        
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function escapeCsv(text) {
            if (typeof text !== 'string') text = String(text);
            return text.replace(/"/g, '""');
        }
    </script>
</body>
</html>
